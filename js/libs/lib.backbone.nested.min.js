!function(t,e){"undefined"!=typeof exports?module.exports=e(require("jquery"),require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["jquery","underscore","backbone"],e):e(t.$,t._,t.Backbone)}(this,function(t,e,n){"use strict";var i,r=[];return n.NestedModel=n.Model.extend({get:function(t){return n.NestedModel.walkThenGet(this.attributes,t)},previous:function(t){return n.NestedModel.walkThenGet(this._previousAttributes,t)},has:function(t){var n=this.get(t);return!(null===n||e.isUndefined(n))},set:function(t,r,a){var o,s,l,u=n.NestedModel.deepClone(this.attributes);if(e.isString(t)?o=n.NestedModel.attrPath(t):e.isArray(t)&&(o=t),o)a=a||{},this._setAttr(u,o,r,a);else{a=r||{};var h=t;for(var c in h)h.hasOwnProperty(c)&&this._setAttr(u,n.NestedModel.attrPath(c),a.unset?void 0:h[c],a)}return i=n.NestedModel.__super__.changedAttributes.call(this),a.unset&&o&&1===o.length?(s={},s[t]=void 0,i=e.omit(i,e.keys(s)),l=n.NestedModel.__super__.set.call(this,s,a)):(s=u,a.unset&&o?(a=e.extend({},a),delete a.unset):a.unset&&e.isObject(t)&&(s=t),i=e.omit(i,e.keys(s)),l=n.NestedModel.__super__.set.call(this,s,a)),l?(this._runDelayedTriggers(),this):(this.changed={},i={},!1)},unset:function(t,n){return this.set(t,void 0,e.extend({},n,{unset:!0}))},clear:function(t){i={},t=t||{};var n=e.clone(this.attributes);if(!t.silent&&this.validate&&!this.validate(n,t))return!1;var r=this.changed={},a=this,o=function(t,n,i){e.each(t,function(s,l){var u=n;e.isArray(t)?u+="["+l+"]":n?u+="."+l:u=l,s=t[l],e.isObject(s)&&o(s,u,i),i.silent||a._delayedChange(u,null,i),r[u]=null})};return o(this.attributes,"",t),this.attributes={},t.silent||this._delayedTrigger("change"),this._runDelayedTriggers(),this},add:function(t,n,i){t=t.replace("[]","");var r=this.get(t);if(r||(r=[],this.set(t,r,{silent:!0})),!e.isArray(r))throw Error("current value is not an array");return this.set(t+"["+r.length+"]",n,i),r.push(n),this.trigger("add:"+t,this,r),this},remove:function(t,n,i){i=i||{};var r=this.get(t);if(0==t.slice(-3).indexOf("[")){var n=r,r=this.get(t.slice(0,t.length-3)),a=e.without(r,n);this.set(t.slice(0,t.length-3),a,{silent:!0})}else{if(!e.isArray(r))throw Error("current value is not an array");var a=e.without(r,n);this.set(t,a,i)}return i.silent||this.trigger("remove:"+t.slice(0,t.length-3),this,a),this},changedAttributes:function(t){var r=n.NestedModel.__super__.changedAttributes.call(this,t);return e.isObject(r)?e.extend({},i,r):!1},toJSON:function(){return n.NestedModel.deepClone(this.attributes)},_delayedTrigger:function(){r.push(arguments)},_delayedChange:function(t,e,n){this._delayedTrigger("change:"+t,this,e,n),this.changed||(this.changed={}),this.changed[t]=e},_runDelayedTriggers:function(){for(;r.length>0;)this.trigger.apply(this,r.shift())},_setAttr:function(t,i,r,a){a=a||{};var o=i.length,s=this;n.NestedModel.walkPath(t,i,function(t,l,u){var h=e.last(l),c=n.NestedModel.createAttrStr(l),d=!e.isEqual(t[h],r);if(l.length===o){if(a.unset){if(delete t[h],e.isArray(t)){var f=n.NestedModel.createAttrStr(e.initial(i));s._delayedTrigger("remove:"+f,s,t[h])}}else t[h]=r;if(!a.silent&&e.isObject(r)&&d){var p=[],g=function(t,n){if(e.indexOf(p,t)<=-1){p.push(t);var i,r;for(var o in t)t.hasOwnProperty(o)&&(i=n+"."+o,r=t[o],e.isEqual(s.get(i),r)||s._delayedChange(i,r,a),e.isObject(r)&&g(r,i))}};g(r,c)}}else t[h]||(t[h]=e.isNumber(u)?[]:{});a.silent||l.length>1&&d&&s._delayedChange(c,t[h],a)})}},{attrPath:function(t){var n;return e.isString(t)?(n=""===t?[""]:t.match(/[^\.\[\]]+/g),n=e.map(n,function(t){return t.match(/^\d+$/)?parseInt(t,10):t})):n=t,n},createAttrStr:function(t){var n=t[0];return e.each(e.rest(t),function(t){n+=e.isNumber(t)?"["+t+"]":"."+t}),n},deepClone:function(t){return JSON.parse(JSON.stringify(t))},walkPath:function(t,e,n,i){for(var r,a=t,o=0;o<e.length&&(n.call(i||this,a,e.slice(0,o+1),e[o+1]),r=e[o],a=a[r],a);o++);},walkThenGet:function(t,i){var r,a=n.NestedModel.attrPath(i);return n.NestedModel.walkPath(t,a,function(t,n){var i=e.last(n);n.length===a.length&&(r=t[i])}),r}}),n});
